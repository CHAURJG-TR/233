<!doctype html>
<html lang="zh-TW" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>簽到系統</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto">
   <div class="min-h-full flex flex-col items-center justify-center px-4 py-8" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8">
     <h1 id="pageTitle" class="text-4xl font-bold text-center mb-2" style="color: #667eea;">簽到系統</h1>
     <p id="welcomeMessage" class="text-center text-gray-600 mb-8">請輸入您的姓名進行簽到</p>
     <form id="checkInForm" class="mb-8"><label for="nameInput" class="block text-sm font-medium text-gray-700 mb-2">姓名</label> <input type="text" id="nameInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors mb-4" placeholder="請輸入您的姓名" required> <button type="submit" id="checkInButton" class="w-full py-3 rounded-lg font-semibold text-white transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" style="background-color: #667eea;"> <span id="buttonText">立即簽到</span> </button>
     </form>
     <div id="successMessage" class="hidden mb-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded">
      <p class="font-semibold">✓ 簽到成功！</p>
     </div>
     <div id="recordsSection">
      <h2 class="text-xl font-bold mb-4" style="color: #667eea;">簽到記錄</h2>
      <div id="recordsList" class="space-y-2 max-h-64 overflow-y-auto">
       <p class="text-gray-500 text-center py-4">尚無簽到記錄</p>
      </div>
      <div id="recordCount" class="text-sm text-gray-600 mt-3 text-center">
       總計：0 次簽到
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      page_title: '簽到系統',
      welcome_message: '請輸入您的姓名進行簽到',
      button_text: '立即簽到',
      primary_color: '#667eea',
      background_gradient_start: '#667eea',
      background_gradient_end: '#764ba2',
      text_color: '#374151',
      font_family: 'system-ui, -apple-system, sans-serif',
      font_size: 16
    };

    let records = [];
    let isSubmitting = false;

    const dataHandler = {
      onDataChanged(data) {
        records = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderRecords();
      }
    };

    async function onConfigChange(config) {
      const pageTitle = document.getElementById('pageTitle');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const buttonTextElement = document.getElementById('buttonText');
      const checkInButton = document.getElementById('checkInButton');
      const headings = document.querySelectorAll('h1, h2');
      
      const title = config.page_title || defaultConfig.page_title;
      const welcome = config.welcome_message || defaultConfig.welcome_message;
      const btnText = config.button_text || defaultConfig.button_text;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const bgStart = config.background_gradient_start || defaultConfig.background_gradient_start;
      const bgEnd = config.background_gradient_end || defaultConfig.background_gradient_end;
      const textColor = config.text_color || defaultConfig.text_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      pageTitle.textContent = title;
      welcomeMessage.textContent = welcome;
      buttonTextElement.textContent = btnText;
      
      pageTitle.style.color = primaryColor;
      document.querySelectorAll('h2').forEach(h2 => h2.style.color = primaryColor);
      checkInButton.style.backgroundColor = primaryColor;
      
      const appDiv = document.querySelector('#app > div');
      appDiv.style.background = `linear-gradient(135deg, ${bgStart} 0%, ${bgEnd} 100%)`;
      
      document.body.style.color = textColor;
      
      pageTitle.style.fontFamily = `${fontFamily}, system-ui, -apple-system, sans-serif`;
      welcomeMessage.style.fontFamily = `${fontFamily}, system-ui, -apple-system, sans-serif`;
      buttonTextElement.style.fontFamily = `${fontFamily}, system-ui, -apple-system, sans-serif`;
      
      pageTitle.style.fontSize = `${fontSize * 2.5}px`;
      welcomeMessage.style.fontSize = `${fontSize}px`;
      buttonTextElement.style.fontSize = `${fontSize * 1.125}px`;
      document.querySelectorAll('h2').forEach(h2 => h2.style.fontSize = `${fontSize * 1.5}px`);
    }

    function renderRecords() {
      const recordsList = document.getElementById('recordsList');
      const recordCount = document.getElementById('recordCount');
      
      if (records.length === 0) {
        recordsList.innerHTML = '<p class="text-gray-500 text-center py-4">尚無簽到記錄</p>';
        recordCount.textContent = '總計：0 次簽到';
        return;
      }

      recordsList.innerHTML = records.map(record => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <div class="flex-1">
            <p class="font-semibold text-gray-800">${escapeHtml(record.name)}</p>
            <p class="text-sm text-gray-600">${record.date} ${record.time}</p>
          </div>
          <button 
            onclick="deleteRecord('${record.__backendId}')" 
            class="text-red-500 hover:text-red-700 transition-colors px-3 py-1 rounded hover:bg-red-50"
            aria-label="刪除記錄"
          >
            ✕
          </button>
        </div>
      `).join('');
      
      recordCount.textContent = `總計：${records.length} 次簽到`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function deleteRecord(backendId) {
      const record = records.find(r => r.__backendId === backendId);
      if (!record) return;

      const result = await window.dataSdk.delete(record);
      if (!result.isOk) {
        showMessage('刪除失敗，請稍後再試', false);
      }
    }

    function showMessage(message, isSuccess = true) {
      const successMessage = document.getElementById('successMessage');
      const messageText = successMessage.querySelector('p');
      
      messageText.textContent = isSuccess ? `✓ ${message}` : `✗ ${message}`;
      successMessage.className = isSuccess 
        ? 'mb-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded'
        : 'mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded';
      
      successMessage.classList.remove('hidden');
      
      setTimeout(() => {
        successMessage.classList.add('hidden');
      }, 3000);
    }

    document.getElementById('checkInForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isSubmitting) return;
      
      if (records.length >= 999) {
        showMessage('已達到最大記錄數量限制（999筆），請先刪除一些記錄', false);
        return;
      }

      const nameInput = document.getElementById('nameInput');
      const name = nameInput.value.trim();
      const checkInButton = document.getElementById('checkInButton');
      
      if (!name) return;

      isSubmitting = true;
      checkInButton.disabled = true;
      document.getElementById('buttonText').textContent = '簽到中...';

      const now = new Date();
      const record = {
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        name: name,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('zh-TW'),
        time: now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })
      };

      const result = await window.dataSdk.create(record);
      
      isSubmitting = false;
      checkInButton.disabled = false;
      document.getElementById('buttonText').textContent = window.elementSdk?.config?.button_text || defaultConfig.button_text;

      if (result.isOk) {
        nameInput.value = '';
        showMessage('簽到成功！');
      } else {
        showMessage('簽到失敗，請稍後再試', false);
      }
    });

    async function init() {
      const dataResult = await window.dataSdk.init(dataHandler);
      if (!dataResult.isOk) {
        console.error('資料 SDK 初始化失敗');
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.background_gradient_start || defaultConfig.background_gradient_start,
                set: (value) => {
                  config.background_gradient_start = value;
                  window.elementSdk.setConfig({ background_gradient_start: value });
                }
              },
              {
                get: () => config.background_gradient_end || defaultConfig.background_gradient_end,
                set: (value) => {
                  config.background_gradient_end = value;
                  window.elementSdk.setConfig({ background_gradient_end: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['page_title', config.page_title || defaultConfig.page_title],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
            ['button_text', config.button_text || defaultConfig.button_text]
          ])
        });
      }

      await onConfigChange(window.elementSdk?.config || defaultConfig);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9afc8d1f62868451',t:'MTc2NjAzODc5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
